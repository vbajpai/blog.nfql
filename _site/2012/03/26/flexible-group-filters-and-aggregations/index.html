
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Flexible Group Filters and Aggregations</title>
   <meta name="author" content="Vaibhav Bajpai" />
   <link href="http://feeds.feedburner.com/feedname" rel="alternate" title="your title" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

  <div class="site">
    <div class="title">
      <a href="/">NFQL</a>
    </div>

    
<div id="post">
  <h1>Flexible Group Filters and Aggregations</h1>
  <p class="meta">
    26 March 2012 
    
  </p>
  <ul>
<li>
<p><code>gfilter_rule</code> now takes in a <code>uint_X</code> RULE when mapping functions (1)</p>

<pre><code>  struct gfilter_rule gfilter_branch1[1] = {
-   {trace_data-&gt;offsets.dPkts, 200, 0, RULE_GT, NULL}
+   {trace_data-&gt;offsets.dPkts, 200, 0, RULE_GT | RULE_S1_32, NULL}
  };</code></pre>

<p>The additional RULE is used to map to a function that knows the type of the offset at RUNTIME (2).</p>

<pre><code>  switch (binfos[i].gfilter_rules[j].op) {
-   case RULE_EQ:
-     binfos[i].gfilter_rules[j].func = gfilter_eq;
+   case RULE_EQ | RULE_S1_32:
+     binfos[i].gfilter_rules[j].func = gfilter_eq_uint32_t;
+   break;
  ...
  }</code></pre>

<p>The additional switch cases and comparison functions are automatically generated using <code>fun_gen.py</code> (3).</p>
</li>

<li>
<p>removed <code>uintX_t</code> assumptions from grouper aggregations</p>

<p>The aggregation function needs to know the type of the offsets used previously in the filter and grouper rules to be able to fill in common fields in its cooked v5 group aggregation record. As a result a <code>get_aggr_fptr(â€¦)</code> function was defined that takes in those previous rules to fall through a switch to return a function pointer to an aggregation function of the correct type (2).</p>

<pre><code>  switch (op) {
+   case RULE_EQ | RULE_S1_8:
+   case RULE_NE | RULE_S1_8:
+   case RULE_GT | RULE_S1_8:
    ...
+     aggr_function = aggr_static_uint8_t;
+     break;
  }</code></pre>

<p>This aggregation function is then later used to fill in the common fields (4). An example using the filter rules is given below:</p>

<pre><code>struct aggr (*aggr_function)(
                              char **records,
                              char *group_aggregation,
                              size_t num_records,
                              size_t field_offset,
                              bool if_aggr_common
                            ) = NULL;

aggr_function = get_aggr_fptr( binfo-&gt;filter_rules[i].op );    

(*aggr_function)(
                  group-&gt;members,
                  group_aggregation,
                  group-&gt;num_members, 
                  field_offset, 
                  TRUE
                );</code></pre>

<p>A similar call is made for the grouper rules as well. The additional switch cases and comparison functions are automatically generated using <code>fun_gen.py</code> (3)</p>

<p>The idea of returning a function pointer from a function makes me question if I am trying to write LISP in C? A quick google search led me to (5)</p>
</li>
</ul>

<p>Resources:</p>

<p>(1) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/flowy_8c.html'><code>flowy</code> reference &#8594;</a><br />(2) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/auto__assign_8c.html'><code>auto_assign</code> reference &#8594;</a><br />(3) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/fun__gen_8py.html'><code>fun_gen</code> reference &#8594;</a><br />(4) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/grouper_8c.html'><code>grouper</code> reference &#8594;</a><br />(5) <a href='http://en.wikipedia.org/wiki/Greenspun&apos;s_tenth_rule'>greenspun&#8217;s tenth rule, wikipedia &#8594;</a></p>
</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>26 Mar 2012</span> &raquo; <a href="/2012/03/26/v21-it-works">v2.1: it works</a></li>
    
      <li><span>26 Mar 2012</span> &raquo; <a href="/2012/03/26/ungrouper-implementation">Ungrouper Implementation</a></li>
    
      <li><span>26 Mar 2012</span> &raquo; <a href="/2012/03/26/clubbing-together-the-hardcoded-rules">Clubbing Together the Hardcoded Rules</a></li>
    
  </ul>
</div>




    <div class="footer">
      <div class="contact">
        <p>
          Vaibhav Bajpai<br />
          <a href='mailto:contact@vaibhavbajpai.com'>contact@vaibhavbajpai.com</a>
        </p>
      </div>
      <div class="contact">
        <p>
          <a href="http://github.com/vbajpai/">github.com/vbajpai</a><br />
          <a href="http://facebook.com/vaibhavbajpai/">facebook.com/vaibhavbajpai</a><br />
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/feedname">
          <img src="/assets/themes/tom/images/rss.png" alt="Subscribe to RSS Feed" />
        </a>
      </div>
    </div>
  </div>
  <a href="http://github.com/vbajpai"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

  
</body>
</html>

