
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Complete Execution Engine Refactor</title>
   <meta name="author" content="Vaibhav Bajpai" />
   <link href="http://feeds.feedburner.com/feedname" rel="alternate" title="your title" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

  <div class="site">
    <div class="title">
      <a href="/">NFQL</a>
    </div>

    
<div id="post">
  <h1>Complete Execution Engine Refactor</h1>
  <p class="meta">
    11 April 2012 
    
  </p>
  <ul>
<li>
<p>The complete project flow is reorganized to increase readability (1, 2)</p>

<p><img alt='parse_cmdline_args(…)' src='http://i.imgur.com/bwNbS.png' /><br /><img alt='parse_json_query(…))' src='http://i.imgur.com/fGEHp.png' /><br /><img alt='prepare_flowquery(…)' src='http://i.imgur.com/o0aNo.png' /><br /><img alt='read_param_data(…)' src='http://i.imgur.com/bNZyn.png' /><br /><img alt='filter(…)' src='http://i.imgur.com/boMWR.png' /><br /><img alt='get_grouper_intermediate(…)' src='http://i.imgur.com/0ajML.png' /><br /><img alt='grouper_aggregations(…)' src='http://i.imgur.com/l9wcn.png' /><br /><img alt='grouperfilter(…)' src='http://i.imgur.com/nI5EY.png' /><br /><img alt='merger(…)' src='http://i.imgur.com/jR86d.png' /> <br /><img alt='ungrouper(…)' src='http://i.imgur.com/5CTgc.png' /></p>
</li>

<li>
<p>Query rules are clubbed in <code>X_ruleset</code>, <code>X</code> is <code>filter</code>, <code>grouper</code>, <code>gfilter</code>, <code>merger</code> (3)</p>

<ul>
<li>
<p><code>flowquery {...}</code></p>

<pre><code>struct flowquery {  
  size_t                          num_branches;  
  struct branch**                 branchset;  
  			  
  size_t                          num_merger_rules;  
  struct merger_rule**            mruleset;
  
  struct merger_result*           merger_result; 
  struct ungrouper_result*        ungrouper_result;
};	</code></pre>
</li>

<li>
<p><code>branch {...}</code></p>

<pre><code>struct branch {

  /*---------------------------------------------------------------*/  
  /*                          inputs                               */
  /*---------------------------------------------------------------*/  
  ...		
  size_t                          num_filter_rules;
  size_t                          num_grouper_rules;
  size_t                          num_aggr_rules;
  size_t                          num_gfilter_rules;
  
  struct filter_rule**            filter_ruleset;  
  struct grouper_rule**           grouper_ruleset;
  struct aggr_rule**              aggr_ruleset;  
  struct gfilter_rule**           gfilter_ruleset;  
  /*---------------------------------------------------------------*/  

  /*---------------------------------------------------------------*/  
  /*                          output                               */
  /*---------------------------------------------------------------*/  
  struct filter_result*           filter_result;
  struct grouper_result*          grouper_result;
  struct groupfilter_result*      gfilter_result;
  /*---------------------------------------------------------------*/  

};</code></pre>
</li>
</ul>
</li>

<li>
<p>Each stage returns <code>X_result</code> <code>X</code> is <code>filter</code>, <code>grouper</code>, <code>gfilter</code>, <code>merger</code>, <code>ungrouper</code> (3).</p>

<ul>
<li>
<p><code>filter(...)</code> returns <code>filter_result</code></p>

<pre><code>struct filter_result* filter(...) {...}</code></pre>

<p>where</p>

<pre><code>struct filter_result {          
  size_t                          num_filtered_records;
  char**                          filtered_recordset;  
};</code></pre>
</li>

<li>
<p><code>grouper(...)</code> returns <code>grouper_result</code></p>

<pre><code>struct grouper_result* grouper(...) {...}</code></pre>

<p>where</p>

<pre><code>struct grouper_result {
  size_t                          num_unique_records;  
  char**                          sorted_recordset;
  char**                          unique_recordset;
  
  size_t                          num_groups;  
  struct group**                  groupset;
};		</code></pre>
</li>

<li>
<p><code>groupfilter(...)</code> returns <code>groupfilter_result</code></p>

<pre><code>struct groupfilter_result* groupfilter(...) {...}</code></pre>

<p>where</p>

<pre><code>struct groupfilter_result {
  size_t                          num_filtered_groups;  
  struct group**                  filtered_groupset;
};</code></pre>
</li>

<li>
<p><code>merger(...)</code> returns <code>merger_result</code></p>

<pre><code>struct merger_result* merger(...) {...}</code></pre>

<p>where</p>

<pre><code>struct merger_result {
  size_t                          num_group_tuples;  
  size_t                          total_num_group_tuples;
  struct group***                 group_tuples;
};</code></pre>
</li>

<li>
<p><code>ungrouper(...)</code> returns <code>ungrouper_result</code></p>

<pre><code>struct ungrouper_result* ungrouper(...) {...}</code></pre>

<p>where</p>

<pre><code>struct ungrouper_result {
  size_t                          num_streams;    
  struct stream**                 streamset;
};</code></pre>
</li>
</ul>
</li>

<li>
<p>Added <code>echo.{h,c}</code> for verbose and debug modes (4)</p>

<ul>
<li>
<p>with atleast <code>--verbose=1</code>:</p>

<p><img alt='echo_filter' src='http://i.imgur.com/1AGfj.png' /></p>

<ul>
<li>
<p>with atleast <code>--verbose=2</code>:</p>

<p><img alt='echo_grouper' src='http://i.imgur.com/sGZff.png' /></p>
</li>
</ul>

<p><img alt='echo_group_aggr' src='http://i.imgur.com/IjdHh.png' /><br /><img alt='echo_gfilter' src='http://i.imgur.com/4JqOp.png' /><br /><img alt='echo_merger' src='http://i.imgur.com/aKQs0.png' /></p>
</li>

<li>
<p>always:</p>

<p><img alt='echo_results' src='http://i.imgur.com/guxpg.png' /></p>
</li>
</ul>
</li>

<li>
<p><code>X_ruleset</code> are deallocated as soon as <code>X</code> stage returns.</p>

<ul>
<li>
<p><code>grouper(...)</code></p>

<pre><code> branch-&gt;grouper_result = grouper(...); 
 if (branch-&gt;grouper_result == NULL)
   errExit(&quot;grouper(...) returned NULL&quot;);
 else {
 			    
   /* free filter rules */
   ...		
   /* free grouper rules */
   ...				    
   /* free grouper aggregation rules */
   ...		
 }  </code></pre>
</li>

<li>
<p><code>groupfilter(...)</code></p>

<pre><code>branch-&gt;gfilter_result = groupfilter(...);
if (branch-&gt;gfilter_result == NULL)
  errExit(&quot;groupfilter(...) returned NULL&quot;);
else {
   
  /* free group filter rules */
  ...
}</code></pre>
</li>

<li>
<p><code>merger(...)</code></p>

<pre><code>fquery-&gt;merger_result = merger(...); 
  
if (fquery-&gt;merger_result == NULL)
  errExit(&quot;merger(...) returned NULL&quot;);
else {
    
    /* free merger rules */	
    ... 
}    </code></pre>
</li>
</ul>
</li>
</ul>

<p>References:</p>

<p>(1) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/flowy_8c.html'><code>flowy</code> reference &#8594;</a><br />(2) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/branch_8c.html'><code>branch</code> reference &#8594;</a><br />(3) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/structflowquery.html'><code>flowquery</code> reference &#8594;</a><br />(4) <a href='http://dl.dropbox.com/u/500389/mthesis/docs-engine/html/echo_8h_source.html'><code>echo</code> reference &#8594;</a></p>
</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>16 Jun 2012</span> &raquo; <a href="/2012/06/16/regression-test-suite-for-the-execution-engine">Regression Test Suite for the Execution Engine</a></li>
    
      <li><span>14 Jun 2012</span> &raquo; <a href="/2012/06/14/parser-on-ubuntu">Parser on Ubuntu</a></li>
    
      <li><span>14 Jun 2012</span> &raquo; <a href="/2012/06/14/parser-on-mac-os-x">Parser on Mac OS X</a></li>
    
  </ul>
</div>




    <div class="footer">
      <div class="contact">
        <p>
          Vaibhav Bajpai<br />
          <a href='mailto:contact@vaibhavbajpai.com'>contact@vaibhavbajpai.com</a>
        </p>
      </div>
      <div class="contact">
        <p>
          <a href="http://github.com/vbajpai/">github.com/vbajpai</a><br />
          <a href="http://facebook.com/vaibhavbajpai/">facebook.com/vaibhavbajpai</a><br />
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/feedname">
          <img src="/assets/themes/tom/images/rss.png" alt="Subscribe to RSS Feed" />
        </a>
      </div>
    </div>
  </div>
  <a href="http://github.com/vbajpai"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

  
</body>
</html>

