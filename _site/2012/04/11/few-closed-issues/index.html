
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Few Closed Issues</title>
   <meta name="author" content="Vaibhav Bajpai" />
   <link href="http://feeds.feedburner.com/feedname" rel="alternate" title="your title" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

  <div class="site">
    <div class="title">
      <a href="/">NFQL</a>
    </div>

    
<div id="post">
  <h1>Few Closed Issues</h1>
  <p class="meta">
    11 April 2012 
    
  </p>
  <ul>
<li>
<p>Greedily deallocating non-filtered records.</p>

<p>Each branch of the pipeline is executed by a separate thread. Since each branch does NOT have a copy of the trace but points to the original records, individual branches CANNOT free the records that were not filtered by them, since they could be filtered by some other branch. As a consequence, the records that were not filtered by any branch can only be free&#8217;d once all threads join the <code>main(…)</code>, ie. before calling the <code>merger(…)</code>. The following implementation is costly and runs in worst case <code>O(nkm)</code> where <code>n</code> is the number of records in the trace, <code>k</code> is the number of branches, and <code>m</code> is the number of filtered records in each branch.</p>

<pre><code>-  for (int i = 0; i &lt; param_data-&gt;trace-&gt;num_records; i++) {
-    bool if_filtered_record = false;
-    char* record = param_data-&gt;trace-&gt;records[i];
-    for (int j = 0; j &lt; fquery-&gt;num_branches; j++) {
-      struct branch_info* branch = fquery-&gt;branchset[j];        
-      for (int k = 0; k &lt; branch-&gt;filter_result-&gt;num_filtered_records; k++) {
-        char* filtered_record = branch-&gt;filter_result-&gt;filtered_recordset[k];
-	  ...
-    }
-    if (!if_filtered_record) {
-      free(record); record = NULL;
-      param_data-&gt;trace-&gt;records[i] = NULL;      
-    }

    struct merger_result* mresult = merger(...)
    ...</code></pre>

<p>Instead, it would be better to extend the trace structure to allow a flag that stores meta-information about the record.</p>

<pre><code>    struct ft_data {
-     char**                          records;
+     struct record**                 recordset;
+     int                             num_records;
    };
 
+   struct record {
+     char*                           record;
+     bool                            if_filtered;
+   };	</code></pre>

<p>Now, the same can free the non-filtered records in worst case <code>O(n)</code> time where <code>n</code> is the number of records in the trace.</p>

<pre><code>+  for (int i = 0; i &lt; param_data-&gt;trace-&gt;num_records; i++) {      
+    struct record* recordinfo = param_data-&gt;trace-&gt;recordset[i];
+    if (recordinfo-&gt;if_filtered == false)
+      free(recordinfo-&gt;record); recordinfo-&gt;record = NULL;
   }</code></pre>
</li>

<li>
<p>Resolved a Grouper segfault when NO records got filtered.</p>

<pre><code>   struct filter_result* fresult = filter(...);
+  if (fresult-&gt;num_filtered_records == 0)
+    pthread_exit(NULL);
      
   struct grouper_result* gresult = grouper(...);  </code></pre>
</li>
</ul>
</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>11 Apr 2012</span> &raquo; <a href="/2012/04/11/complete-execution-engine-refactor">Complete Execution Engine Refactor</a></li>
    
      <li><span>11 Apr 2012</span> &raquo; <a href="/2012/04/11/complete-execution-engine-profiling">Complete Execution Engine Profiling</a></li>
    
      <li><span>26 Mar 2012</span> &raquo; <a href="/2012/03/26/v21-it-works">v2.1: it works</a></li>
    
  </ul>
</div>




    <div class="footer">
      <div class="contact">
        <p>
          Vaibhav Bajpai<br />
          <a href='mailto:contact@vaibhavbajpai.com'>contact@vaibhavbajpai.com</a>
        </p>
      </div>
      <div class="contact">
        <p>
          <a href="http://github.com/vbajpai/">github.com/vbajpai</a><br />
          <a href="http://facebook.com/vaibhavbajpai/">facebook.com/vaibhavbajpai</a><br />
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/feedname">
          <img src="/assets/themes/tom/images/rss.png" alt="Subscribe to RSS Feed" />
        </a>
      </div>
    </div>
  </div>
  <a href="http://github.com/vbajpai"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

  
</body>
</html>

