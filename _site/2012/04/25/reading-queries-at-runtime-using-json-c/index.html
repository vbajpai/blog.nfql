
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Reading Queries at Runtime using json c</title>
   <meta name="author" content="Vaibhav Bajpai" />
   <link href="http://feeds.feedburner.com/feedname" rel="alternate" title="your title" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

  <div class="site">
    <div class="title">
      <a href="/">NFQL</a>
    </div>

    
<div id="post">
  <h1>Reading Queries at Runtime using json c</h1>
  <p class="meta">
    25 April 2012 
    
  </p>
  <p>The complete query is now read in at runtime. The query is supplied as a <code>JSON</code> file. The branchsets and each ruleset of the pipeline is a <code>JSON</code> array. Each array is preceded by the number of items in that array. A sample <code>JSON</code> query is shown below:</p>

<pre><code>{
  &quot;branchset&quot;: [
    &quot;num_branches&quot;: 2
    {
      &quot;filter&quot;: {
        &quot;num_rules&quot;: 2,
        &quot;ruleset&quot;: [...]
      },

      &quot;grouper&quot;: {
        &quot;num_rules&quot;: 2,
        &quot;ruleset&quot;: [...]
      }

      &quot;aggregation&quot;: {
        &quot;num_rules&quot;: 4,
        &quot;ruleset&quot;: [...]
      },
      
      &quot;groupfilter&quot;: {
        &quot;num_rules&quot;: 1,
        &quot;ruleset&quot;: [...]
      },
    },
    { 
      ...
    }
  ],
  &quot;merger&quot;: {
  &quot;num_rules&quot;: 2,
    &quot;ruleset&quot;: [...]
  },
}</code></pre>

<p><code>json-c</code> (1) is used to parse the query read by calling <code>parse_json_query(...)</code></p>

<pre><code>struct json* json_query = parse_json_query(param_data-&gt;query_mmap);</code></pre>

<p>The structure thus filled looks like:</p>

<pre><code>struct json {
  size_t                          num_branches;
  size_t                          num_mrules;
  
  struct json_branch_rules**      branchset;
  struct json_merger_rule**       mruleset;
};</code></pre>

<p>where each branch rule looks like:</p>

<pre><code>struct json_branch_rules {
  size_t                          num_frules;
  size_t                          num_grules;
  size_t                          num_arules;
  size_t                          num_gfrules;
  
  struct json_filter_rule**       fruleset;
  struct json_grouper_rule**      gruleset;
  struct json_aggr_rule**         aruleset;  
  struct json_gfilter_rule**      gfruleset;    
};</code></pre>

<p>The <code>json_query</code> is then used to prepare the <code>flowquery</code>struct used by the stages (2).</p>

<pre><code>struct flowquery* fquery = prepare_flowquery(param_data-&gt;trace, json_query);</code></pre>

<p>Practically, the <code>json_query</code> is just an intermediate and shouldn&#8217;t be needed. Essentially <code>parse_json_query(...)</code> should directly fill in and create the <code>flowquery</code> struct. I see it as a future refactor item.</p>

<p>Resources:</p>

<p>(1) <a href='http://oss.metaparadigm.com/json-c/'><code>json-c</code> Library &#8594;</a><br />(2) <a href='http://mthesis.vaibhavbajpai.com/post/20901257812/complete-engine-refactor'><code>flowquery</code> structs and its descendents &#8594;</a></p>
</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>27 Apr 2012</span> &raquo; <a href="/2012/04/27/v23-its-flexible">v2.3: it's flexible</a></li>
    
      <li><span>25 Apr 2012</span> &raquo; <a href="/2012/04/25/runtime-query-internals">Runtime Query Internals</a></li>
    
      <li><span>25 Apr 2012</span> &raquo; <a href="/2012/04/25/generating-json-queries-using-python">Generating JSON queries using Python</a></li>
    
  </ul>
</div>




    <div class="footer">
      <div class="contact">
        <p>
          Vaibhav Bajpai<br />
          <a href='mailto:contact@vaibhavbajpai.com'>contact@vaibhavbajpai.com</a>
        </p>
      </div>
      <div class="contact">
        <p>
          <a href="http://github.com/vbajpai/">github.com/vbajpai</a><br />
          <a href="http://facebook.com/vaibhavbajpai/">facebook.com/vaibhavbajpai</a><br />
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/feedname">
          <img src="/assets/themes/tom/images/rss.png" alt="Subscribe to RSS Feed" />
        </a>
      </div>
    </div>
  </div>
  <a href="http://github.com/vbajpai"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

  
</body>
</html>

